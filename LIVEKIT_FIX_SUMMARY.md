# LiveKit Invalid Authorization Token - Complete Fix Summary

## Problem
‚ùå **Live broadcast fails with: "invalid authorization token" from LiveKit**

## Root Cause Analysis
The LiveKit server rejects the JWT token generated by the backend. This can happen due to:
1. Invalid or expired `LIVEKIT_API_KEY` and `LIVEKIT_API_SECRET`
2. Token encoding/signing issues
3. Token claim format mismatch with LiveKit server expectations
4. LiveKit server configuration issues

## Solutions Implemented

### 1. Backend Enhancements (src/controllers/liveController.js)

#### Enhanced Host Token Generator
- Added detailed logging showing token generation process
- Includes JWT payload inspection (decoded header and claims)
- Validates all required environment variables
- Shows token technical details for debugging

#### Enhanced Viewer Token Generator  
- Same improvements as host token
- Ensures viewers get properly formatted tokens
- Logs all claims for verification

### 2. New Debug Endpoint (src/routes/liveRoutes.js)

**New Route**: `POST /api/live/debug/generate-test-token`
- Authentication required (JWT token)
- Generates a test token without starting broadcast
- Returns decoded JWT payload for inspection
- Perfect for diagnosing token generation issues

**Usage**:
```bash
curl -X POST http://192.168.1.106:5000/api/live/debug/generate-test-token \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json"
```

### 3. Flutter Improvements

#### Better Error Handling (live_broadcast_screen.dart)
- Validates token format before connecting
- Checks JWT has 3 parts separated by dots
- Specific error messages for different failure types
- Comprehensive console logging for debugging

#### Enhanced Token Extraction (live_api_service.dart)
- Logs token source and extraction method
- Shows token length and type
- Helps identify token parsing issues

#### Fixed UI Layout (start_live_screen.dart)
- ‚úÖ Fixed RenderFlex overflow (20 pixels)
- Added ScrollView for responsive layout
- Better dropdown item handling

## Critical Configuration to Verify

### .env File (Backend)
```
LIVEKIT_URL=wss://eyra-8at81fjw.livekit.cloud
LIVEKIT_API_KEY=APIJ6Cnro4AHqqQ
LIVEKIT_API_SECRET=s9JibGKNgc2BTTsxCmGRewxo2GiDN0KrUinfsGpjT1J
```

‚ö†Ô∏è **IMPORTANT**: These credentials must match exactly with your LiveKit Cloud account!

### Verification Steps

#### Step 1: Check Backend Logs
When starting broadcast, look for:
```
üîµ [generateHostToken] Creating token...
   userId: 696546cd8583356234ce59bc (type: string)
   roomId: room_1768251594373_0c751329
   LIVEKIT_API_KEY: ‚úì SET (APIJ6...)
   LIVEKIT_API_SECRET: ‚úì SET (s9JibG...)
‚úÖ [generateHostToken] Token created successfully
   Header: {"alg":"HS256","typ":"JWT"}
   Payload: {
     "sub": "696546cd8583356234ce59bc",
     "aud": "livekit",
     "video": {...}
   }
```

#### Step 2: Test Token Generation
```bash
# Use the new debug endpoint
POST /api/live/debug/generate-test-token
```

Response should show:
- ‚úÖ Token with 3 JWT parts
- ‚úÖ Payload with correct claims
- ‚úÖ Proper algorithm (HS256)

#### Step 3: Check Flutter Logs
Monitor the Flutter console for:
```
‚úÖ Using provided LiveKit token
üîç Token details:
   Length: ~500 chars
   Prefix: eyJhbGciOiJIUzI1NiIsInR5c...
üîå Attempting to connect to LiveKit...
   URL: wss://eyra-8at81fjw.livekit.cloud
```

## If Issue Persists

### Option 1: Verify API Credentials
1. Login to https://cloud.livekit.io
2. Go to your project
3. Check API Keys section
4. Regenerate keys if needed
5. Update `.env` file with exact values
6. Restart backend: `npm start`

### Option 2: Check LiveKit Server
1. Verify `LIVEKIT_URL` is correct
2. Test connectivity: `curl -I wss://eyra-8at81fjw.livekit.cloud`
3. Check if server is up and running
4. Ensure no firewall/network blocking

### Option 3: Review Token Claims
Using the debug endpoint, verify:
- ‚úÖ `sub` (subject/identity) is set correctly
- ‚úÖ `aud` (audience) is "livekit"
- ‚úÖ `video` section has proper grants
- ‚úÖ `exp` (expiration) is in future

## Files Modified

1. **src/controllers/liveController.js**
   - `generateHostToken()` - Enhanced logging
   - `generateViewerToken()` - Enhanced logging

2. **src/routes/liveRoutes.js**
   - Added `POST /api/live/debug/generate-test-token`

3. **lib/features/live/screens/live_broadcast_screen.dart**
   - `_connectToRoom()` - Better error handling and logging

4. **lib/features/live/services/live_api_service.dart**
   - `_extractToken()` - Enhanced debugging

5. **lib/features/live/screens/start_live_screen.dart**
   - Fixed RenderFlex overflow
   - Better responsive layout

## Quick Testing Sequence

1. **Restart Backend**
   ```bash
   npm start
   ```

2. **Check Backend Logs**
   - Look for "LIVEKIT_API_KEY: ‚úì SET"
   - Look for "LIVEKIT_API_SECRET: ‚úì SET"

3. **Test Token Generation**
   ```bash
   # Call the debug endpoint
   curl -X POST http://192.168.1.106:5000/api/live/debug/generate-test-token \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

4. **Start Broadcast in Flutter**
   - Monitor console for token-related logs
   - Watch for "Attempting to connect to LiveKit"
   - Check for connection success or specific error

5. **If Connection Fails**
   - Note exact error message
   - Check backend token decoding output
   - Verify API credentials match LiveKit console
   - Regenerate credentials if needed

## Important Notes

‚ö†Ô∏è **Security**: 
- Never commit API credentials to git
- Use `.env` file (which is gitignored)
- Regenerate credentials if they've been exposed

‚ö†Ô∏è **Token Expiration**:
- Tokens expire after 1 hour by default
- For long streams, may need token refresh mechanism
- Currently not implemented, but should be added for production

‚ö†Ô∏è **CORS & WebSocket**:
- Ensure device/browser can reach LiveKit WebSocket URL
- Check firewall rules allow WSS connections
- No CORS issues for WebSocket connections (browser limitation)

## Reference Documentation

- LiveKit SDK Docs: https://docs.livekit.io/
- livekit-server-sdk-js: https://github.com/livekit/server-sdk-js
- Flutter LiveKit Client: https://pub.dev/packages/livekit_client

---

**Implementation Date**: January 13, 2026
**Status**: ‚úÖ Complete - Ready for Testing
**Next Step**: Verify with actual LiveKit Cloud credentials
